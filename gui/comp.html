<html lang="en">
  
  <head>
    <meta charset="UTF-8" />
    <title>Facet demonstration</title>
  </head>
  
  <body>
  
    <form>
      <count-view value="0">Hello</count-view><hr/>
      <count-view value="3">G'day</count-view>
    </form>
    
    <templates>
    
      <template component="inc-button" mixins="click-inc state">
        <button>+</button>
      </template>

      <template component="dec-button" mixins="click-dec state">
        <button>-</button>
      </template>

      <template component="num-output" mixins="click-new">
        <code><slot></slot></code>
      </template>

      <template component="count-view" mixins="define atomic dispatch" observe="value" forminput>
        <slot has="count"></slot>s
        <inc-button></inc-button>
        <num-output></num-output>
        <dec-button></dec-button>
      </template>
      
      <template mixin="click-dec">
        <script on="click">
          host.parentNode.count--;
        </script>
      </template>

      <template mixin="click-inc">
        <script on="click">
          host.parentNode.count++;
        </script>
      </template>
      
      <template mixin="click-new">
        <script on="value.change">
          host.textContent = event.detail.newValue;
        </script>
        <script on="connect">
          host.classList.add('change-target')
        </script>
      </template>
      
      <template mixin="define">
        <script on="connect">
          this.definition = document.querySelector(`template[component=${host.tagName.toLowerCase()}]`);
          this.observed = this.observed ?? this.definition.getAttribute("observe").split(" ")
            .map((attr) => ({detail:{ name:attr, newValue: host.getAttribute(attr) }}));
        </script>
      </template>
      
      <template mixin="atomic">
        <script on="connect">
        
          const state = {};
          this.observed.forEach(e=> {
            let attr = e.detail.name;
            let slot = root.querySelector('slot');
            let name = slot.getAttribute("has") ?? 'state';
            let hash = this.tagName+'-'+djb2Hash(this.outerHTML)
            let atom = parseInt(sessionStorage.getItem(hash) ?? host.getAttribute(attr));
            
            let save =  debounce((val) => {
              sessionStorage.setItem(hash, val);
            }, 300);          
            
            let show =  debounce((val) => {
              host.setAttribute(attr,val)
            });   
            
            Object.defineProperty(root,name,{
              get: ()=>atom,
              set: (val)=> {
                atom = val;
                show (val);
                save (val);
              },
            })
            
            root[name] = atom;
          });
          
          // host.state =state 
          //[...root.children].forEach(child=>child.state = state)
          
        </script>
      </template>

      <template mixin="dispatch">
        <script on="connect" once>

          this.targets = root.querySelectorAll('.change-target')
          this.targets.forEach((tgt) =>
            this.observed.forEach((initEvent) => {
              tgt.dispatchEvent(attributeChange(initEvent))
            }),
          );
          
        </script>
        <script on="attributeChanged">
          if(!this.targets) return;
          this.targets.forEach((tgt) => tgt.dispatchEvent(attributeChange(event)))
        </script>
      </template>            
      
    </templates>
    
  <script>
    function attributeChange(event) {
      return new CustomEvent(event.detail.name + ".change", {
        detail: event.detail,
        bubbles: false,
      });
    }
    function djb2Hash(str) {
      let hash = 5381;
      for (let i = 0; i < str.length; i++) {
        hash = (hash * 33) ^ str.charCodeAt(i); // Bitwise XOR
      }
      return hash >>> 0; // Convert to unsigned 32-bit integer
    }
    function debounce(fn, delay) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
      };
    }
  </script>
      
  <script src="https://cdn.jsdelivr.net/gh/kgscialdone/facet@0.1.2a/facet.min.js" shadow="open"></script>
  </body>
 
</html>
